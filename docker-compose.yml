services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - DATABASE_URL=${DATABASE_URL:?DATABASE_URL is required}
      - JWT_SECRET=${JWT_SECRET:?JWT_SECRET is required}
      - PORT=3001
      - ADMIN_USERNAME=${ADMIN_USERNAME:?ADMIN_USERNAME is required}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:?ADMIN_PASSWORD is required}
      - ALLOWED_ORIGINS=https://${DOMAIN:?DOMAIN is required}
      - NODE_ENV=production
    restart: unless-stopped
    networks:
      - web
      - internal
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.recipe-api.rule=Host(`${DOMAIN}`) && PathPrefix(`/trpc`, `/health`)'
      - 'traefik.http.routers.recipe-api.priority=100'
      - 'traefik.http.routers.recipe-api.entrypoints=websecure'
      - 'traefik.http.routers.recipe-api.tls.certresolver=letsencrypt'
      - 'traefik.http.services.recipe-api.loadbalancer.server.port=3001'
      # HTTP to HTTPS redirect
      - 'traefik.http.routers.recipe-api-http.rule=Host(`${DOMAIN}`) && PathPrefix(`/trpc`, `/health`)'
      - 'traefik.http.routers.recipe-api-http.priority=100'
      - 'traefik.http.routers.recipe-api-http.entrypoints=web'
      - 'traefik.http.routers.recipe-api-http.middlewares=redirect-to-https'
      - 'traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https'
      - 'traefik.http.routers.recipe-api.middlewares=security-headers@docker'
      - 'traefik.docker.network=web'

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    environment:
      - ORIGIN=https://${DOMAIN}
      - BODY_SIZE_LIMIT=10485760
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - web
      - internal
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.recipe-frontend.rule=Host(`${DOMAIN}`)'
      - 'traefik.http.routers.recipe-frontend.priority=10'
      - 'traefik.http.routers.recipe-frontend.entrypoints=websecure'
      - 'traefik.http.routers.recipe-frontend.tls.certresolver=letsencrypt'
      - 'traefik.http.services.recipe-frontend.loadbalancer.server.port=3000'
      # HTTP to HTTPS redirect
      - 'traefik.http.routers.recipe-frontend-http.rule=Host(`${DOMAIN}`)'
      - 'traefik.http.routers.recipe-frontend-http.priority=10'
      - 'traefik.http.routers.recipe-frontend-http.entrypoints=web'
      - 'traefik.http.routers.recipe-frontend-http.middlewares=redirect-to-https'
      - 'traefik.http.routers.recipe-frontend.middlewares=security-headers@docker'
      - 'traefik.docker.network=web'

networks:
  web:
    external: true
  internal:
    driver: bridge
